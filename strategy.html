<!DOCTYPE html>

<link href="/public/stylesheets/bootstrap-3.1.1-dist/css/bootstrap.css" rel="stylesheet">
<style type="text/css">

</style>
<html>
<script src="/public/javascripts/jquery-1.7.1.js"></script>
<script src="/public/javascripts/dygraph-combined.js"></script>
<script src="/public/javascripts/backbone-min.js"></script>

<script type="text/javascript"> 

  jQuery.extend({
        postJSON: function(params) {
            return jQuery.ajax(jQuery.extend(params, {
                type: "POST",
                data: params.data,
                dataType: "json",
                contentType: "application/json",
                processData: false
            }));
        }
    });
  

 $.fn.serializeObject = function()
 {
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
        if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
                o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
        } else {
            o[this.name] = this.value || '';
        }
    });
    return o;
 };

  var expirationsArray = new Array();

  jQuery(document).on('ready', function() {
        $('#gobutton').click(function(event) {
          event.preventDefault();
          console.log("came here");
          console.log($('#ticker').val());
          $.getJSON( "getTimeFrames/"+$('#ticker').val(), function( data ) {
            //now populate expiration with this data
            $(data.expirations.option).each(function()
            {
                  //this refers to the current item being iterated over
                 var option = $('<option />');
                 option.attr('value', this.contract).text(this.contract);
                 expirationsArray.push(this.contract);
                 $('#expiration_0').append(option);
           });

           
           /*
            $.postJSON({
                url: '/getTimeFrames',
                data: { val1: this.input1.value, val2: this.input2.value },
                success: function(json) {
                    alert(JSON.stringify(json));
                },
                error: function(err) {
                    alert(err.responseText);
                }
            });
            */
           // return true;
        });
           $.getJSON( "getStockPrice/"+$('#ticker').val(), function( data ) {
            console.log(data);
            $('#stockPrice').val(data.stockPrice);    
        });
        return true;
    });
  
    var strikePremium = {};

   $('#positionsTable').undelegate('.expiration').delegate('.expiration', 'change', function() {
    // do your processing here
       var thisType = $(this).closest('.tr_clone').find('.type').children().first().val();
       var strikeRef = $(this).closest('.tr_clone').find('.strike').children().first();
       var thisExpiration=$(this).attr('value');
       var premiumRef = $(this).closest('.tr_clone').find('.premium').children().first();
       strikeRef.html("<option value=\"\">-----</option>");
       premiumRef.val('');
       //console.log(thisType);
       strikeRef.prop('disabled', 'disabled');
       $.getJSON( "getOptionChain/"+$('#ticker').val()+"/"+$(this).attr('value'), function( data ) {
            console.log(data);
            strikeRef.removeAttr('disabled');  
      
            $(data.chain.optionsChain.option).each(function()
            {
               //this refers to the current item being iterated over
               //alert($(this).parent().siblings('#addr_0').find('#type_0').val());
            
               if(thisType == this.type)
               {
                  var option = $('<option />');
                  option.attr('value', this.strikePrice).text(this.strikePrice);
                  strikeRef.append(option);
               }
               strikePremium[thisExpiration+this.type+this.strikePrice] = this.lastPrice; 
             
           });

        });
        return false;
   });
   
    $('#positionsTable').undelegate('.type').delegate('.type', 'change', function() {
    // do your processing here
       var thisType = $(this).attr('value');
       var thisExpiration = $(this).closest('.tr_clone').find('.expiration').children().first().val();
       var strikeRef = $(this).closest('.tr_clone').find('.strike').children().first();
       var premiumRef = $(this).closest('.tr_clone').find('.premium').children().first();
    
       //console.log(thisType);
       strikeRef.prop('disabled', 'disabled');
       if(thisExpiration == "" || thisType == "")
       {
          if(strikeRef.val() !="")
          {
            strikeRef.val("");
          }
          premiumRef.val("");
          return false;
       }
       if(strikeRef.val() != "")
      {
         var premium = strikePremium[thisExpiration+thisType+strikeRef.val()];
         premiumRef.val(premium);   
         strikeRef.removeAttr('disabled');  
       }
      
       $.getJSON( "getOptionChain/"+$('#ticker').val()+"/"+thisExpiration, function( data ) {
            console.log(data);
            strikeRef.removeAttr('disabled');  
      
            $(data.chain.optionsChain.option).each(function()
            {
               //this refers to the current item being iterated over
               //alert($(this).parent().siblings('#addr_0').find('#type_0').val());
            
               if(thisType == this.type)
               {
                  var option = $('<option />');
                  option.attr('value', this.strikePrice).text(this.strikePrice);
                  strikeRef.append(option);
               }
               strikePremium[thisExpiration+this.type+this.strikePrice] = this.lastPrice; 
             
           });

        });
        return false;
   });

   $('#positionsTable').undelegate('.strike').delegate('.strike', 'change', function() {
      var thisType = $(this).closest('.tr_clone').find('.type').children().first().val();
      var premiumRef = $(this).closest('.tr_clone').find('.premium').children().first();
      var thisExpiration = $(this).closest('.tr_clone').find('.expiration').children().first().val();
      var premium = strikePremium[thisExpiration+thisType+$(this).attr('value')];
      premiumRef.val(premium);   
      return false;
    });

    $('#subbtn').click(function(event) {
          event.preventDefault();
           var formdata = JSON.stringify($('form').serializeObject());
           console.log(formdata);
           $.postJSON({
                url: 'getPnL',
                data: formdata,
                success: function(json) {
                    console.log(json);
                    //alert(JSON.stringify(json));
                    var g = new Dygraph(document.getElementById("graph"),
                 // For possible data formats, see http://dygraphs.com/data.html
                 json,
                 {
                     // options go here. See http://dygraphs.com/options.html
                     legend: 'always',
                     animatedZooms: true,
                     title: 'P&L Chart',
                     ylabel: 'Profit',
                     xlabel: 'Stock at Expiration'
                 });
                },
                error: function(err) {
                    alert(err.responseText);
                }
            });
    });
  var rowCounter=1;
 $("#addButton").click(function(){

        var $tr = $(this).closest('.tr_clone');
        var allTrs = $tr.closest('table').find('.tr_clone');
        var lastTr = allTrs[allTrs.length-1];
        var $clone = $(lastTr).clone();

        $clone.find('td').each(function(){
            var el = $(this).find(':first-child');
            var id = el.attr('id') || null;
            console.log(id);
            if(id) {
                var i = id.substr(id.length-1);
                var prefix = id.substr(0, (id.length-1));
                el.attr('id', prefix+(+i+1));
                el.attr('name', prefix+(+i+1));
            }
        });

        $clone.find('input:text').val('');
        $clone.find('.strike').children().first().html("<option value=\"\">-----</option>");
        $clone.find('.addButton').hide();
        $tr.closest('table').append($clone);
    //$(this).closest('.addr0').clone().insertAfter(".addr0");
  /*
         $('#addr'+rowCounter).html("<td><select name='transaction_"+rowCounter+"' id='transaction_"+rowCounter+"' class='order-type'><option value=''>- -</option><option value='BUY'>Buy</option><option value='SELL'>Sell</option></select></td><td><input type='text' value='' name='contracts_"+rowCounter+"' id='contracts_"+rowCounter+"' style='width:100%;height:100%''> </td><td><select width='100%'' class='type osi-option-type' name='type_"+rowCounter+"' id='type_"+rowCounter+"' tabindex='8'><option>- -</option><option value='C'>Call</option><option value='P'>Put</option></select></td><td><select name='expiration_"+rowCounter+"' id='expiration_"+rowCounter+"' class='expiration' tabindex='9'><option value=''>-------</option></select></td><td><select width='100%' name='strike_"+rowCounter+"' id='strike_"+rowCounter+"' class='strike' tabindex='4'><option value=''>-----</option></td><td><input type='text' value='' name='premium_"+rowCounter+"' id='premium_"+rowCounter+"' style='width:100%;height:100%''></td><td></td>");
        $('#positionsTable').append('<tr id="addr'+(rowCounter+1)+'"></tr>');
        $('#expiration_'+(rowCounter-1).clone(true).appendTo('');
   
      for(var expirationsIndex=0; expirationsIndex < expirationsArray.length;expirationsIndex++)
      {
           var option = $('<option />');
           option.attr('value', expirationsArray[expirationsIndex]).text(expirationsArray[expirationsIndex]);
           console.log(option);
        $('#expiration_'+rowCounter).append(option);
     
      }
      */
   
        rowCounter++; 
    });

    $('#positionsTable').undelegate('.deleteButton').delegate('.deleteButton', 'click', function() {
        var $tr = $(this).closest('.tr_clone');
        $tr.remove();
    });

});
</script>
<body>

	<div align="center">
		 <h2>Strategy Builder</h2>
	</div>
<form class="form-inline" id="optionform">

  <div class="row">
  <div class="span5 offset4" align="center">
   <br>
     <b>Ticker :</b> <input type="text" size="5" class="span1" name="ticker" id="ticker" value="" > 
  	 <input type="submit" value="Go" id="gobutton" class="btn-mini btn-primary">
     <img src="/public/images/clear.gif"   width="30">
     <label class="control-label"><b>Stock Price :</b></label>
  	 <input type="text" id="stockPrice"   value="" name="stockPrice" class="span1" size="10"> 
     <img src="/public/images/refresh.gif" alt="Refresh" height="15" width="10" onclick="Change_Cursor('');queryYQL()"/>   
  </div>
  </div>
  	<br/>
  	<div class="row">
      <div class="col-xs-12 col-sm-8 col-md-6 col-sm-offset-2 col-md-offset-3" align="center">
      <table class="table" id="positionsTable">
      <tr>
         <td><b>Order Type</b></td>
         <td><b>Contracts</b></td>
         <td><b>Type</b></td> 
         <td><b>Expiration</b></td>
         <td><b>Strike</b></td>
         <td><b>Premium</b></td>
         <td></td>
      </tr>
      <tr id="addr0" class="tr_clone">
        <td class="transaction"><select width="100%" name="transaction_0" id="transaction_0" class="order-type" tabindex="6"><option value="">- -</option><option value="BUY">Buy</option><option value="SELL">Sell</option></select></td>
          <td>
            <input type="text"  value="" name="contracts_0" id="contracts_0" style="width:100%;height:100%"> 
          </td>
        
        <td class="type"><select width="100%" class="type osi-option-type" name="type_0"  id="type_0" tabindex="8"><option value="">- -</option><option value="C">Call</option><option value="P">Put</option></select></td>
        <td class="expiration"><select name="expiration_0" id="expiration_0" class="expiration" tabindex="9"><option value="">-------</option></select></td>
        <td class="strike"><select width="100%" name="strike_0" id="strike_0" class="strike" tabindex="4"><option value="">-----</option></td>
        <td class="premium">
          <input type="text" value="" name="premium_0" id="premium_0" style="width:100%;height:100%">
        </td>
         <td>
          <img class='deleteButton' src="public/images/delete.png"/>
        </td>
        <td>
          <input class="addButton" type="button" id="addButton" value="Add"/>
        </td>
      </tr>
     
     </table>
     </div>
    </div>
    
   
     <!--
  	 <div class="row">
  	<div class="span3 offset3" align="center">
        	  <input size=5  class="span1" type="text" name="contracts_1" id="contracts_1" />
            <select class="span2" id="type_1" name="type_1" onchange="Change_Cursor('');queryYQL3(this)"><option value="--" >--</option><option value="C">CALL</option><option value="P">PUT</option></select>
            <select class="span2" name="strike_1" id="strike_1"  onchange="Change_Cursor('');queryYQL3(this)"><option value="--">--</option></select>
            <img src="/public/images/refresh.gif" alt="Refresh" height="15" width="10" onclick="Change_Cursor('');queryYQL2Refresh(this)"/> 
            <input class="span1" size=10 type="text" name="premium_1" id="premium_1" /></td>
           <img src="/public/images/refresh.gif" alt="Refresh" height="15" width="10" onclick="Change_Cursor('');queryYQL3(this)"/>
          <select class="span2" id="longshort_1" name="longshort_1" "><option value="--">--</option><option value="BUY">Buy</option><option value="SELL">Sell</option></select>
        	<select class="span2" name="expiration_1" id="expiration_1"  onchange="Change_Cursor('');queryYQL2();"><option>--</option></select>
        <img src="/public/images/refresh.gif" alt="Refresh" height="15" width="10" onclick="Change_Cursor('');queryYQL1()"/>
            <input type="button" class="btn-mini btn-danger" id="delPOIbutton" value="Delete" onclick="deleteRow(this)"/>
    </div>
     </div>
   -->
   
    <div class="row">
      <div class="col-xs-12 col-sm-8 col-md-6 col-sm-offset-2 col-md-offset-3" align="center">
       <button id="subbtn" type="submit"  class="btn btn-primary">Submit</button>
       <input type="hidden" id="savepos" name="savepos" value="false"/>
       <button  id="savebtn" type="submit" class="btn btn-primary" onclick="document.getElementById('savepos').value='true';">Save Position</button>
       </div>
    </div>
    <br/>
    <br/>
   <div class="row"> 
      <div class="col-md-6 col-lg-6 col-md-offset-3" align="center">
         <div id="graph"></div>
      </div>
    </div> 
  <!--
    <div id="positionsdiv" class="offset12" >
    <b> Positions</b>
    </div>
-->
</form>

</body>
</html>